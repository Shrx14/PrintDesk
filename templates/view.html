{% extends "base.html" %}

{% block title %}View Data{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-center flex-grow-1">üìÑ Uploaded Printer Logs</h2>
    <div class="text-end">
      <!-- Only fullscreen button remains at top -->
      <button id="fullscreen-btn" class="btn btn-outline-dark btn-sm">üî≥ Fullscreen</button>
    </div>
  </div>

  {% if data is not none %}
    <form id="filter-form" method="get" action="{{ url_for('view') }}">
      <div id="table-container" class="table-responsive" style="max-height: 70vh; overflow: auto;">
        <table id="data-table" class="table table-bordered table-striped table-hover align-middle w-auto">
      <div class="d-flex justify-content-end mb-2">
        {% set query_string = request.query_string.decode('utf-8') %}
        <a href="{{ url_for('download_excel') }}{% if query_string %}?{{ query_string }}{% endif %}" class="btn btn-success">
          ‚¨áÔ∏è Download as Excel
        </a>
      </div>

      <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table id="data-table" class="table table-bordered table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>Sr No</th>
              {% for col in data.columns %}
                <th>{{ col|title }}</th>
              {% endfor %}
            </tr>
            <tr class="filter-row">
              <th></th>
              {% for col in data.columns %}
                <th>
                  <select name="{{ col }}" onchange="document.getElementById('filter-form').submit()" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for val in unique_values[col] %}
                      <option value="{{ val }}" {% if request.args.get(col) == val %}selected{% endif %}>{{ val }}</option>
                    {% endfor %}
                  </select>
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data.itertuples() %}
              <tr>
                <td>{{ (page - 1) * 100 + loop.index }}</td>
                {% for val in row[1:] %}
                  <td>{{ val }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>

    {% set args = request.args.to_dict() %}
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
          {% set prev_args = args.copy() %}
          {% set _ = prev_args.update({'page': page - 1}) %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('view', **prev_args) }}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
          {% set page_args = args.copy() %}
          {% set _ = page_args.update({'page': p}) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('view', **page_args) }}">{{ p }}</a>
          </li>
        {% endfor %}

        {% if page < total_pages %}
          {% set next_args = args.copy() %}
          {% set _ = next_args.update({'page': page + 1}) %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('view', **next_args) }}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>

    <style>
      #data-table td,
      #data-table th {
        padding: 4px 8px !important;
        vertical-align: middle;
        font-size: 0.875rem;
        white-space: nowrap;
      }

      .filter-row select {
        padding: 2px 6px;
        height: auto;
        font-size: 0.85rem;
        line-height: 1.2;
        width: 100%;
      }

      #data-table tbody tr {
        line-height: 1;
      }

      /* Fullscreen styles */
      :fullscreen #table-container,
      :-webkit-full-screen #table-container {
        width: 100vw !important;
        height: 100vh !important;
        background: white;
        padding: 1rem;
        overflow: auto;
        z-index: 9999;
      }
    </style>

    <script>
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const tableContainer = document.getElementById('table-container');

      fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          tableContainer.requestFullscreen().then(() => {
            fullscreenBtn.textContent = 'üîô Exit Fullscreen';
          }).catch(err => {
            alert(`Error: ${err.message}`);
          });
        } else {
          document.exitFullscreen().then(() => {
            fullscreenBtn.textContent = 'üî≥ Fullscreen';
          });
        }
      });

      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          fullscreenBtn.textContent = 'üî≥ Fullscreen';
        }
      });
    </script>

  {% else %}
    <div class="alert alert-warning text-center">
      No data uploaded yet. Please <a href="{{ url_for('upload') }}">upload an Excel file</a> first.
    </div>
  {% endif %}

  <!-- üìç Moved Dashboard button here next to Home -->
  <div class="mt-5 text-center">
    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary me-2">üè† Home</a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">üìä Dashboard</a>
  </div>
{% endblock %}
