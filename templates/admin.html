{% extends "base.html" %}
{% block title %}Admin Management{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="text-center mb-5">ðŸ‘‘ Admin User Management</h2>

  

  <div class="row g-4">
    <!-- User List & Add User -->
    <div class="col-md-6">
      <div class="card bg-dark text-white shadow">
        <div class="card-header bg-primary text-white">
          <strong>Users</strong>
        </div>
        <ul id="userList" class="list-group list-group-flush">
          {% for username in users %}
            <li class="list-group-item" data-username="{{ username }}">{{ username }}</li>
          {% endfor %}
        </ul>

        <div class="card-header bg-primary text-white mt-4">
          <strong>Add New User</strong>
        </div>
        <form id="addUserForm" class="p-3">
          <div class="mb-3">
            <label for="newUsername" class="form-label">Username</label>
            <input type="text" id="newUsername" class="form-control" placeholder="Enter username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Permission</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="newUserPermission" id="permView" value="view">
              <label class="form-check-label" for="permView">View</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="newUserPermission" id="permUpload" value="upload">
              <label class="form-check-label" for="permUpload">Upload</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="newUserPermission" id="permAdmin" value="admin">
              <label class="form-check-label" for="permAdmin">Admin</label>
            </div>
          </div>
          <button type="submit" class="btn btn-success w-100">Add User</button>
        </form>
      </div>
    </div>

    <!-- Manage Selected User -->
    <div class="col-md-6">
      <div class="card bg-dark text-white shadow">
        <div class="card-header bg-secondary text-white">
          <strong>Manage User Permissions</strong>
        </div>
        <form id="userPermissionsForm" class="p-3">
          <div class="mb-3">
            <label for="selectedUsername" class="form-label">Selected User</label>
            <input type="text" id="selectedUsername" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Permission</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="permissionRadio" id="manageView" value="view">
              <label class="form-check-label" for="manageView">View</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="permissionRadio" id="manageUpload" value="upload">
              <label class="form-check-label" for="manageUpload">Upload</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="permissionRadio" id="manageAdmin" value="admin">
              <label class="form-check-label" for="manageAdmin">Admin</label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100" id="saveChangesBtn">
            <span class="btn-text">Save Changes</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;" id="saveChangesSpinner"></span>
          </button>
  <div id="flashMessage" class="flash-message" style="display:none; margin-top: 0.5rem;"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// User data passed from Flask backend
const users = JSON.parse(`{{ users | tojson | safe }}`);

const userList = document.getElementById('userList');
const selectedUsernameInput = document.getElementById('selectedUsername');
const manageView = document.getElementById('manageView');
const manageUpload = document.getElementById('manageUpload');
const manageAdmin = document.getElementById('manageAdmin');
let selectedUser = null;

function clearSelection() {
  userList.querySelectorAll('li').forEach(item => item.classList.remove('active'));
}

function updateManageUserForm(username) {
  selectedUsernameInput.value = username;
  const perms = users[username];

  // Set only one permission checked
  manageView.checked = perms.view && !perms.upload && !perms.admin;
  manageUpload.checked = perms.upload && !perms.view && !perms.admin;
  manageAdmin.checked = perms.admin && !perms.view && !perms.upload;
}

userList.addEventListener('click', (e) => {
  if (e.target && e.target.tagName === 'LI') {
    const username = e.target.getAttribute('data-username');
    selectedUser = username;
    clearSelection();
    e.target.classList.add('active');
    updateManageUserForm(username);
  }
});

const firstUser = userList.querySelector('li');
if (firstUser) {
  firstUser.classList.add('active');
  selectedUser = firstUser.getAttribute('data-username');
  updateManageUserForm(selectedUser);
}

// Flash message display function
function showFlashMessage(message, type='info') {
  // Use the flashMessage div inside the userPermissionsForm
  const flashMessageDiv = document.querySelector('#userPermissionsForm #flashMessage');
  flashMessageDiv.textContent = message;
  flashMessageDiv.className = 'flash-message flash-' + type;
  flashMessageDiv.style.display = 'block';

  // Auto-dismiss after 4 seconds
  setTimeout(() => {
    flashMessageDiv.style.display = 'none';
  }, 4000);
}

const saveChangesBtn = document.getElementById('saveChangesBtn');
const saveChangesSpinner = document.getElementById('saveChangesSpinner');

document.getElementById('addUserForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const username = document.getElementById('newUsername').value.trim();
  if (!username || users[username]) {
    showFlashMessage('Invalid or duplicate username.', 'error');
    return;
  }

  const selectedPermission = document.querySelector('input[name="newUserPermission"]:checked');
  if (!selectedPermission) {
    showFlashMessage('Please select a permission.', 'error');
    return;
  }

  const roles = [selectedPermission.value];

  fetch('/add_user', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, roles })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      showFlashMessage(`Error: ${data.error}`, 'error');
      return;
    }

    // Update frontend
    users[username] = {
      view: roles.includes('view'),
      upload: roles.includes('upload'),
      admin: roles.includes('admin')
    };

    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.setAttribute('data-username', username);
    li.textContent = username;
    userList.appendChild(li);

    this.reset();
    clearSelection();
    li.classList.add('active');
    selectedUser = username;
    updateManageUserForm(username);

    showFlashMessage(`User ${username} added successfully.`, 'success');
  })
  .catch(error => {
    console.error('Request failed:', error);
    showFlashMessage('An error occurred while adding the user.', 'error');
  });
});

document.getElementById('userPermissionsForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (!selectedUser) {
    showFlashMessage('No user selected.', 'error');
    return;
  }

  saveChangesBtn.disabled = true;
  saveChangesSpinner.style.display = 'inline-block';

  const selectedRole = document.querySelector('input[name="permissionRadio"]:checked');
  if (!selectedRole) {
    showFlashMessage('Please select a permission.', 'error');
    saveChangesBtn.disabled = false;
    saveChangesSpinner.style.display = 'none';
    return;
  }

  const roles = [selectedRole.value];

  fetch('/update_user_permissions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: selectedUser, roles })
  })
  .then(response => response.json())
  .then(data => {
    saveChangesBtn.disabled = false;
    saveChangesSpinner.style.display = 'none';

    if (data.error) {
      showFlashMessage(`Error: ${data.error}`, 'error');
      return;
    }

    users[selectedUser] = {
      view: roles.includes('view'),
      upload: roles.includes('upload'),
      admin: roles.includes('admin')
    };

    showFlashMessage(`Permissions updated for ${selectedUser}`, 'success');
  })
  .catch(error => {
    saveChangesBtn.disabled = false;
    saveChangesSpinner.style.display = 'none';

    console.error('Error updating permissions:', error);
    showFlashMessage('An error occurred while updating permissions.', 'error');
  });
});
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
body {
  background-color: #121212;
  font-family: 'Poppins', sans-serif;
  color: #cfd8dc;
  padding: 3rem 1rem;
}
.card {
  background-color: #263238;
  border-radius: 16px;
  border: 1.5px solid #37474f;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 14px 36px rgba(3, 155, 229, 0.5);
}
.card-header {
  font-weight: 600;
  font-size: 1.25rem;
  text-transform: uppercase;
  letter-spacing: 0.07em;
}
.list-group-item {
  background-color: #37474f;
  color: #cfd8dccc;
  font-weight: 500;
  border: none;
  cursor: pointer;
}
.list-group-item.active {
  background-color: #0288d1;
  color: #eceff1;
}
input.form-control {
  background-color: #263238;
  color: #eceff1;
  border: 1.5px solid #37474f;
}
input.form-control:focus {
  border-color: #4fc3f7;
  background-color: #37474f;
}
button.btn {
  border-radius: 14px;
  text-transform: uppercase;
  font-weight: 600;
}
/* Spinner styles */
.spinner-border {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  vertical-align: text-bottom;
  border: 0.15em solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  animation: spinner-border .75s linear infinite;
  margin-left: 0.5rem;
}

@keyframes spinner-border {
  to { transform: rotate(360deg); }
}
</style>
{% endblock %}
